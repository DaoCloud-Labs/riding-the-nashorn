<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<meta name="author" content="Niko Köbler">
<title>Riding the Nashorn</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="css//asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Riding the Nashorn</h1>
<div class="details">
<span id="author" class="author">Niko Köbler</span><br>
<span id="email" class="email"><a href="mailto:niko@n-k.de">niko@n-k.de</a>, <a href="http://www.n-k.de" class="bare">http://www.n-k.de</a>, <a href="https://twitter.com/dasniko">@dasniko</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_nashorn_at_the_command_line_interface_cli">1. Nashorn at the Command Line Interface (CLI)</a>
<ul class="sectlevel2">
<li><a href="#_scripting_mode">1.1. Scripting mode</a></li>
<li><a href="#_shebang">1.2. Shebang</a></li>
</ul>
</li>
<li><a href="#_nashorn_javascript_engine_from_within_java">2. Nashorn JavaScript Engine from within Java</a>
<ul class="sectlevel2">
<li><a href="#_invoking_javascript_functions_from_java">2.1. Invoking JavaScript functions from Java</a></li>
<li><a href="#_invoking_java_methods_from_javascript">2.2. Invoking Java methods from JavaScript</a></li>
<li><a href="#_scriptobjectmirror">2.3. ScriptObjectMirror</a></li>
<li><a href="#_options_for_the_script_engine">2.4. Options for the script engine</a></li>
<li><a href="#_bindings_context">2.5. Bindings / Context</a></li>
</ul>
</li>
<li><a href="#_api_and_language_extensions">3. API and Language Extensions</a></li>
<li><a href="#_working_with_package_manager">4. Working with Package Manager</a>
<ul class="sectlevel2">
<li><a href="#_npm">4.1. NPM</a></li>
<li><a href="#_maven">4.2. Maven</a></li>
</ul>
</li>
<li><a href="#_isomorphic_javascript">5. Isomorphic JavaScript</a>
<ul class="sectlevel2">
<li><a href="#_isomorphic">5.1. Isomorphic?</a></li>
<li><a href="#_react_js">5.2. React.js</a></li>
<li><a href="#_spring_boot_mvc">5.3. Spring Boot MVC</a></li>
<li><a href="#_java_ee_8_mvc_1_0">5.4. Java EE 8 MVC 1.0</a></li>
</ul>
</li>
<li><a href="#_javafx_with_javascript">6. JavaFX with JavaScript</a></li>
<li><a href="#_testing_of_nashorn_scripts">7. Testing of Nashorn Scripts</a>
<ul class="sectlevel2">
<li><a href="#_junit">7.1. JUnit</a></li>
<li><a href="#_spock">7.2. Spock</a></li>
<li><a href="#_jasmine">7.3. Jasmine</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Nashorn is the official JavaScript Engine in the Java Virtual Machine since Version 8.
It supports and implements the <a href="http://www.ecma-international.org/ecma-262/5.1/">ECMAScript 5.1 specification</a> and competes among others directly with <a href="https://developers.google.com/v8/">Google V8</a> (the script enginge behind <a href="https://nodejs.org">Node.js</a>).
Nashorn compiles JavaScript to Java Bytecode during runtime and thus provides high interoperability of Java and JavaScript.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nashorn.jpg" alt="Nashorn">
</div>
</div>
<div class="paragraph">
<p>In this script I want to dig into some of the (IMO) most used options, functions, features, and use-cases.
After working through this tutorial you&#8217;ll be able to use Nashorn and its dynamic scripting features in your daily Java business.</p>
</div>
<div class="paragraph">
<p><em>Another good starting point for Nashorn resources might be the <a href="http://openjdk.java.net/projects/nashorn/">Official Project Nashorn Website</a> with links to the mailing-list, the blog and the wiki pages. Check it out!</em></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Nashorn in JDK 8 implements, as mentioned above the ECMAScript 5.1 specification. But it&#8217;s Nashorns strategy to follow the ECMAScript spec.
So the follow up major releases of Nashorn will implement <a href="http://www.ecma-international.org/ecma-262/6.0/">ECMAScript 2015 spec</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_nashorn_at_the_command_line_interface_cli">1. Nashorn at the Command Line Interface (CLI)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nashorn comes with a command line client named <code>jjs</code>.</p>
</div>
<div class="paragraph">
<p>This client is located in <code>$JAVA_HOME/bin</code>, but there&#8217;s no shortcut/link/path integration after installation Java 8.
So, if you want to work with <code>jjs</code> - and that&#8217;s what we want to do here - you should create a link to the tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ cd /usr/bin
$ ln -s $JAVA_HOME/bin/jjs jjs
$ jjs
jjs&gt; print('Hello World');</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now evaluate JavaScript code directly in the jjs shell.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">jjs&gt; var x = 10;
jjs&gt; print(x);
10</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally you can load and execute JavaScript files with the <code>jjs</code> tool:</p>
</div>
<div class="listingblock">
<div class="title">test.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">var x = 10;
var y = 20;
print(x + y);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ jjs test.js
30</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Exiting</strong></p>
</div>
<div class="paragraph">
<p>The <code>jjs</code> client can be exited by calling</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">jjs&gt; exit()
jjs&gt; exit(1)

jjs&gt; quit()
jjs&gt; quit(1)</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Help / Options</strong></p>
</div>
<div class="paragraph">
<p>List all options of <code>jjs</code> by calling it with the <code>-help</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ jjs -help</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_scripting_mode">1.1. Scripting mode</h3>
<div class="paragraph">
<p>In addition to the ECMAScript 5.1 specification, Nashorn implements a number of own syntax and API extensions as well <em>(see one of the next chapters)</em>.
Many of these extensions are only available in <code>scripting</code> mode. <code>Scripting</code> mode is turned on by using the cli option <code>--scripting</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ jjs --scripting</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <code>scripting</code> mode, nashorn accepts shell style <code>#</code> single line comments:</p>
</div>
<div class="listingblock">
<div class="title">test.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js"># style line comment -scripting mode
# prints hello

print('hello');</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_shebang">1.2. Shebang</h3>
<div class="paragraph">
<p>Nashorn supports shebang scripting.
So, instead of calling your JavaScript file like the traditional way:</p>
</div>
<div class="listingblock">
<div class="title">test.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">print('hello');</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ jjs test.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just write your JavaScript file like the following with a shebang at first line:</p>
</div>
<div class="listingblock">
<div class="title">test.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">#!/usr/bin/jjs
print('hello');</code></pre>
</div>
</div>
<div class="paragraph">
<p>make it executable and call it from the command line, like any other shell script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ chmod 755 test.js
$ ./test.js</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You&#8217;ll need to have a link to <code>jjs</code> as mentioned at the beginning of this chapter.<br>
Scripting mode is automatically enabled when running shebang Nashorn scripts.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_nashorn_javascript_engine_from_within_java">2. Nashorn JavaScript Engine from within Java</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Nashorn Engine is a JavaScript implementation of the <a href="https://www.jcp.org/en/jsr/detail?id=223">JSR-223</a> <em>(Scripting for the Java Platform)</em>. It implements the <code>javax.script</code> API.
So, for being able to evaluate JavaScript code from Java, we just create a new Nashorn <code>javax.script.ScriptEngine</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ScriptEngine engine = new ScriptEngineManager().getEngineByName("nashorn");
engine.eval("print('Hello World');");</code></pre>
</div>
</div>
<div class="paragraph">
<p>As seen above, JavaScript code can be evaluated directly by passing it as a string to the <code>eval()</code> method of the engine object.
Alternatively you can parse a <code>.js</code>-file by passing a <code>FileReader</code> object pointing to your file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ScriptEngine engine = new ScriptEngineManager().getEngineByName("nashorn");
engine.eval(new FileReader('test.js'));</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_invoking_javascript_functions_from_java">2.1. Invoking JavaScript functions from Java</h3>
<div class="paragraph">
<p>It&#8217;s not only possible to run single JS statements or evaluate complete JS files, but it&#8217;s also possible to invoke JavaScript functions from within Java code.
Additionally you can pass Java objects as function arguments and return data back from the function to the calling Java method.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s assume our JavaScript file:</p>
</div>
<div class="listingblock">
<div class="title">example.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var sayHello = function(name) {
  print('Hello, ' + name + '!');
  return 'hello from javascript';
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>To be able to call our defined <code>sayHello</code> function, we first have to cast the <code>engine</code> object to the <code>Invocable</code> interface, which is implemented by the <code>NashornScriptEngine</code> implementation.
The <code>Invocable</code> interface provides the <code>invokeFunktion()</code> method, which allows to call JavaScript functions for a given name and pass arguments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ScriptEngine engine = new ScriptEngineManager().getEngineByName("nashorn");
engine.eval(new FileReader('example.js'));

Invocable invocable = (Invocable) engine;

Object result = invocable.invokeFunction("sayHello", "John Doe");
System.out.println(result);
System.out.println(result.getClass());

// Hello, John Doe!
// hello from javascript
// class java.lang.String</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our code prints three lines to the console: The JavaScript function <code>print()</code> pipes the result to <code>System.out</code>, afterwards, the two Java <code>System.out.println()</code> methods are evaluated.</p>
</div>
</div>
<div class="sect2">
<h3 id="_invoking_java_methods_from_javascript">2.2. Invoking Java methods from JavaScript</h3>
<div class="paragraph">
<p>Calling or invoking Java methods from JavaScript code is just as easy as vice-versa. Let&#8217;s assume a Java class with two methods:</p>
</div>
<div class="listingblock">
<div class="title">MyJavaClass.java</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package my.package;

public class MyJavaClass {

    public static String sayHello(String name) {
        return String.format("Hello %s from Java!", name);
    }

    public int add(int a, int b) {
        return a + b;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our Java class can be referenced from JavaScript via the <code>Java.type</code> API extension. This is similar to the <code>import</code> statement in Java.
After referencing our Java class, we can call the static method and print the result to <code>System.out</code>.
Since the <code>sayHello()</code> method is static, we don&#8217;t have to create an instance as we have to do for calling the <code>add()</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var MyJavaClass = Java.type('my.package.MyJavaClass');

var greetingResult = MyJavaClass.sayHello('John Doe');
print(greetingResult);

var myClass = new MyJavaClass();
var calcResult = myClass.add(1, 2);
print(calcResult);

// Hello John Doe from Java!
// 3</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_nashorn_type_conversions">2.2.1. Nashorn type conversions</h4>
<div class="paragraph">
<p>With this little example, you can find out, how Nashorn handles type conversions between Java and JavaScript, when calling Java methods from JavaScript.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static void printType(Object object) {
    System.out.println((object.getClass());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, call this static method with different JavaScript types:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">MyJavaClass.printType("Hello");
// class java.lang.String

MyJavaClass.printType(123);
// class java.lang.Integer

MyJavaClass.printType(12.34);
// class java.lang.Double

MyJavaClass.printType(true);
// class java.lang.Boolean

MyJavaClass.printType(new Number(123));
// class jdk.nashorn.internal.objects.NativeNumber
// class jdk.nashorn.api.scripting.ScriptObjectMirror

MyJavaClass.printType(new Date());
// class jdk.nashorn.internal.objects.NativeDate
// class jdk.nashorn.api.scripting.ScriptObjectMirror

MyJavaClass.printType(new RegExp());
// class jdk.nashorn.internal.objects.NativeRegExp
// class jdk.nashorn.api.scripting.ScriptObjectMirror

MyJavaClass.printType({foo: 'bar'});
// class jdk.nashorn.internal.scripts.J04
// class jdk.nashorn.api.scripting.ScriptObjectMirror</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Primitive JavaScript types are converted to the appropriate Java wrapper class.</p>
</li>
<li>
<p>Native JavaScript objects are represented by internal adapter classes, respectively to <code>ScriptObjectMirror</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Don&#8217;t rely on programming against / using internal classes in <code>jdk.nashorn.internal</code> as they are likely subject to change!
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_scriptobjectmirror">2.3. ScriptObjectMirror</h3>
<div class="paragraph">
<p>The <code>ScriptObjectMirror</code> is part of the <code>jdk.nashorn.api</code> and is intended to be used in client-code instead of the internal classes.
This mirror object is a representation of the underlying JavaScript object and provides access to it and its methods and properties.
The <code>ScriptObjectMirror</code> implements the <code>Map</code> interface.</p>
</div>
<div class="paragraph">
<p>We edit our last method slightly to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static void printObjectMirror(ScriptObjectMirror mirror) {
    System.out.println(mirror.getClassName() + ": " + Arrays.toString(mirror.getOwnKeys(true)));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When we call this method now with our last four JS function calls (number, date, regexp and object literal):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">MyJavaClass.printType(new Number(123));
MyJavaClass.printType(new Date());
MyJavaClass.printType(new RegExp());
MyJavaClass.printType({
    foo: 'bar',
    bar: 'foo'
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>we now get this result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Number: []
Date: []
RegExp: [lastIndex, source, global, ignoreCase, multiline]
Object: [foo, bar]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, we can call member functions on JavaScript objects from Java.<br>
Let&#8217;s assume a JavaScript type <code>Person</code> with some properties and a function <code>getFullName()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">function Person(firstName, lastName) {
  this.firstName = firstName;
  this.lastName = lastName;
  this.getFullName = function() {
    return this.firstName + " " + this.lastName;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The function <code>getFullName()</code> can be called on <code>ScriptObjectMirror</code> via <code>callMember()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static void getFullName(ScriptObjectMirror person) {
    System.out.println("Full name is: " + person.callMember("getFullName"));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, our JavaScript code looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var person = new Person('John', 'Doe');
MyJavaClass.getFullName(person);

// Full name is: John Doe</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_options_for_the_script_engine">2.4. Options for the script engine</h3>
<div class="paragraph">
<p>Nashorn script engine customization can be done by using <code>nashorn.args</code> system properties.
Just specify the options you want with <code><strong>-Dnashorn.args=&#8230;&#8203;</strong></code>
E.g. enabling the scripting mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ java -Dnashorn.args=-scripting MyJavaClass</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also create a Nashorn engine by passing customization options programmatically.
In this case, you&#8217;ll have to instantiate <code>NashornScriptEngineFactory</code> directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">NashornScriptEngineFactory factory = new NashornScriptEngineFactory();
ScriptEngine engine = factory.getScriptEngine(new String[] { "-scripting" });</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Available options can be determined from the <a href="#_nashorn_at_the_command_line_interface_cli">command line</a> when calling <code>jjs -help</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_bindings_context">2.5. Bindings / Context</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_api_and_language_extensions">3. API and Language Extensions</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_working_with_package_manager">4. Working with Package Manager</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_npm">4.1. NPM</h3>
<div class="sect3">
<h4 id="_polyfill_js">4.1.1. Polyfill.js</h4>
<div class="listingblock">
<div class="title">nashorn-polyfill.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var global = this;
var window = this;
var process = {env:{}};

var console = {};
console.debug = print;
console.warn = print;
console.log = print;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jvm_npm">4.1.2. JVM-NPM</h4>

</div>
</div>
<div class="sect2">
<h3 id="_maven">4.2. Maven</h3>
<div class="sect3">
<h4 id="_nasven">4.2.1. Nasven</h4>

</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_isomorphic_javascript">5. Isomorphic JavaScript</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_isomorphic">5.1. Isomorphic?</h3>

</div>
<div class="sect2">
<h3 id="_react_js">5.2. React.js</h3>

</div>
<div class="sect2">
<h3 id="_spring_boot_mvc">5.3. Spring Boot MVC</h3>

</div>
<div class="sect2">
<h3 id="_java_ee_8_mvc_1_0">5.4. Java EE 8 MVC 1.0</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_javafx_with_javascript">6. JavaFX with JavaScript</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_testing_of_nashorn_scripts">7. Testing of Nashorn Scripts</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_junit">7.1. JUnit</h3>

</div>
<div class="sect2">
<h3 id="_spock">7.2. Spock</h3>

</div>
<div class="sect2">
<h3 id="_jasmine">7.3. Jasmine</h3>

</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-01-24 16:21:22 UTC
</div>
</div>
</body>
</html>